pipeline {
    agent any

    stages {
        stage('checkout') {
            steps {
                git branch: 'latest', url: 'https://github.com/badigerviresh/10-MicroService-Appliction.git'
            }
        }
        
        stage('adservice') {
            steps {
                script{
                    withDockerRegistry(credentialsId: 'docker-cred', toolName: 'docker') {
                      dir('/var/lib/jenkins/workspace/10-tier/src/adservice') {
                          sh "docker build -t vireshdevopsstudent/adservice:latest ."
                          sh "docker push vireshdevopsstudent/adservice:latest"
                          sh "docker rmi  vireshdevopsstudent/adservice:latest"
                      }       
                    }
                }    
            }
        }
        stage('cartservice') {
            steps {
                script{
                    withDockerRegistry(credentialsId: 'docker-cred', toolName: 'docker') {
                      dir('/var/lib/jenkins/workspace/10-tier/src/cartservice/src/') {
                          sh 'docker build -t vireshdevopsstudent/cartservice:latest .'
                          sh 'docker push vireshdevopsstudent/cartservice:latest'
                          sh 'docker rmi  vireshdevopsstudent/cartservice:latest'
                      }       
                    }
                }    
            }
        }
        stage('checkoutservice') {
            steps {
                script{
                    withDockerRegistry(credentialsId: 'docker-cred', toolName: 'docker') {
                      dir('/var/lib/jenkins/workspace/10-tier/src/checkoutservice/') {
                          sh 'docker build -t vireshdevopsstudent/checkoutservice:latest .'
                          sh 'docker push vireshdevopsstudent/checkoutservice:latest'
                          sh 'docker rmi  vireshdevopsstudent/checkoutservice:latest'
                      }       
                    }
                }    
            }
        }
        stage('currencyservice') {
            steps {
                script{
                    withDockerRegistry(credentialsId: 'docker-cred', toolName: 'docker') {
                      dir('/var/lib/jenkins/workspace/10-tier/src/currencyservice/') {
                          sh 'docker build -t vireshdevopsstudent/currencyservice:latest .'
                          sh 'docker push vireshdevopsstudent/currencyservice:latest'
                          sh 'docker rmi  vireshdevopsstudent/currencyservice:latest'
                      }       
                    }
                }    
            }
        }
        stage('emailservice') {
            steps {
                script{
                    withDockerRegistry(credentialsId: 'docker-cred', toolName: 'docker') {
                      dir('/var/lib/jenkins/workspace/10-tier/src/emailservice/') {
                          sh 'docker build -t vireshdevopsstudent/emailservice:latest .'
                          sh 'docker push vireshdevopsstudent/emailservice:latest'
                          sh 'docker rmi  vireshdevopsstudent/emailservice:latest'
                      }       
                    }
                }    
            }
        }
        stage('frontend') {
            steps {
                script{
                    withDockerRegistry(credentialsId: 'docker-cred', toolName: 'docker') {
                      dir('/var/lib/jenkins/workspace/10-tier/src/frontend/') {
                          sh 'docker build -t vireshdevopsstudent/frontend:latest .'
                          sh 'docker push vireshdevopsstudent/frontend:latest'
                          sh 'docker rmi  vireshdevopsstudent/frontend:latest'
                      }       
                    }
                }    
            }
        }
        stage('loadgenerator') {
            steps {
                script{
                    withDockerRegistry(credentialsId: 'docker-cred', toolName: 'docker') {
                      dir('/var/lib/jenkins/workspace/10-tier/src/loadgenerator/') {
                          sh 'docker build -t vireshdevopsstudent/loadgenerator:latest .'
                          sh 'docker push vireshdevopsstudent/loadgenerator:latest'
                          sh 'docker rmi  vireshdevopsstudent/loadgenerator:latest'
                      }       
                    }
                }    
            }
        }
        stage('paymentservice') {
            steps {
                script{
                    withDockerRegistry(credentialsId: 'docker-cred', toolName: 'docker') {
                      dir('/var/lib/jenkins/workspace/10-tier/src/paymentservice/') {
                          sh 'docker build -t vireshdevopsstudent/paymentservice:latest .'
                          sh 'docker push vireshdevopsstudent/paymentservice:latest'
                          sh 'docker rmi  vireshdevopsstudent/paymentservice:latest'
                      }       
                    }
                }    
            }
        }
        stage('productcatalogservice') {
            steps {
                script{
                    withDockerRegistry(credentialsId: 'docker-cred', toolName: 'docker') {
                      dir('/var/lib/jenkins/workspace/10-tier/src/productcatalogservice/') {
                          sh 'docker build -t vireshdevopsstudent/productcatalogservice:latest .'
                          sh 'docker push vireshdevopsstudent/productcatalogservice:latest'
                          sh 'docker rmi  vireshdevopsstudent/productcatalogservice:latest'
                      }       
                    }
                }    
            }
        }
        stage('recommendationservice') {
            steps {
                script{
                    withDockerRegistry(credentialsId: 'docker-cred', toolName: 'docker') {
                      dir('/var/lib/jenkins/workspace/10-tier/src/recommendationservice/') {
                          sh 'docker build -t vireshdevopsstudent/recommendationservice:latest .'
                          sh 'docker push vireshdevopsstudent/recommendationservice:latest'
                          sh 'docker rmi  vireshdevopsstudent/recommendationservice:latest'
                      }       
                    }
                }    
            }
        }
        stage('shippingservice') {
            steps {
                script{
                    withDockerRegistry(credentialsId: 'docker-cred', toolName: 'docker') {
                      dir('/var/lib/jenkins/workspace/10-tier/src/shippingservice/') {
                          sh 'docker build -t vireshdevopsstudent/shippingservice:latest .'
                          sh 'docker push vireshdevopsstudent/shippingservice:latest'
                          sh 'docker rmi  vireshdevopsstudent/shippingservice:latest'
                      }       
                    }
                }    
            }
        }
        stage('K8-Deploy') {
            steps {
                withKubeConfig(caCertificate: '', clusterName: 'my-eks10', contextName: '', credentialsId: 'my-token', namespace: 'webapps', restrictKubeConfigAccess: false, serverUrl: 'https://8B436B397272C26F0740B53FA93161B6.gr7.ap-south-1.eks.amazonaws.com') {
                    sh 'kubectl apply -f deployment-service.yml -n webapps' 
                    sh 'kubectl get pods -n webapps'
                    sh 'kubectl get svc -n webapps'
                }    
            }
        }
    }
}
